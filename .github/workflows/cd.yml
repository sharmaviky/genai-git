name: CD - Deploy to Docker Desktop (WSL)

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Build Docker Image
        run: |
          docker build -t genai-app:latest .

      - name: Save Docker Image as Tar
        run: docker save genai-app:latest -o genai-app.tar

      - name: Deploy to WSL Docker
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "Copying Docker image tar file to server..."
            cat > genai-app.tar

            echo "Loading Docker image..."
            docker load -i genai-app.tar

            echo "Stopping old container if exists..."
            docker stop genai-app || true
            docker rm genai-app || true

            echo "Running new container..."
            docker run -d --name genai-app -p 3000:3000 genai-app:latest
        # Upload file over SSH
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          command_timeout: 200s
          script_stop: true
          source: "genai-app.tar"
          target: "./genai-app.tar"
